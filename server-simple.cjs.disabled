const express = require('express');
const cors = require('cors');
const bcrypt = require('bcryptjs');
const jwt = require('jsonwebtoken');
const sqlite3 = require('sqlite3').verbose();

const app = express();
const PORT = 8081; // ä½¿ç”¨ä¸åŒç«¯å£é¿å…å†²çª

// JWTå¯†é’¥ - ç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨ç¯å¢ƒå˜é‡
const JWT_SECRET = 'kekeYueDu_secret_key_2025';

// ä¸­é—´ä»¶
app.use(cors());
app.use(express.json());

// JWTè®¤è¯ä¸­é—´ä»¶
const authenticateToken = (req, res, next) => {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1]; // Bearer TOKEN

  if (!token) {
    return res.status(401).json({
      success: false,
      message: 'è®¿é—®è¢«æ‹’ç»ï¼Œéœ€è¦è®¤è¯ä»¤ç‰Œ'
    });
  }

  jwt.verify(token, JWT_SECRET, (err, user) => {
    if (err) {
      return res.status(403).json({
        success: false,
        message: 'ä»¤ç‰Œæ— æ•ˆæˆ–å·²è¿‡æœŸ'
      });
    }

    req.user = user;
    next();
  });
};

// å†…å­˜æ•°æ®åº“ç”¨äºæµ‹è¯•
const users = [];
let userIdCounter = 1;
let draftIdCounter = 1;

// === ç”¨æˆ·è®¤è¯è·¯ç”± ===

// ç”¨æˆ·æ³¨å†Œ
app.post('/api/register', async (req, res) => {
  try {
    const { username, password, confirmPassword } = req.body;

    // æ•°æ®éªŒè¯
    if (!username || !password || !confirmPassword) {
      return res.status(400).json({
        success: false,
        message: 'è¯·å¡«å†™æ‰€æœ‰å­—æ®µ'
      });
    }

    if (username.trim().length < 3) {
      return res.status(400).json({
        success: false,
        message: 'ç”¨æˆ·åè‡³å°‘éœ€è¦3ä¸ªå­—ç¬¦'
      });
    }

    if (password.length < 6) {
      return res.status(400).json({
        success: false,
        message: 'å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦'
      });
    }

    if (password !== confirmPassword) {
      return res.status(400).json({
        success: false,
        message: 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´'
      });
    }

    const hasLetter = /[a-zA-Z]/.test(password);
    const hasNumber = /[0-9]/.test(password);
    if (!hasLetter || !hasNumber) {
      return res.status(400).json({
        success: false,
        message: 'å¯†ç å¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—'
      });
    }

    // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
    const existingUser = users.find(u => u.username === username.trim());
    if (existingUser) {
      return res.status(409).json({
        success: false,
        message: 'ç”¨æˆ·åå·²å­˜åœ¨'
      });
    }

    // å¯†ç åŠ å¯†
    const hashedPassword = await bcrypt.hash(password, 12);

    // åˆ›å»ºæ–°ç”¨æˆ·
    const newUser = {
      id: userIdCounter++,
      username: username.trim(),
      password: hashedPassword,
      email: null,
      created_at: new Date().toISOString()
    };

    users.push(newUser);

    console.log('æ–°ç”¨æˆ·æ³¨å†ŒæˆåŠŸ:', { id: newUser.id, username: newUser.username });

    // ä¸ºæ–°æ³¨å†Œç”¨æˆ·ç”ŸæˆJWTä»¤ç‰Œ
    const token = jwt.sign(
      {
        id: newUser.id,
        username: newUser.username
      },
      JWT_SECRET,
      { expiresIn: '24h' }
    );

    res.status(201).json({
      success: true,
      message: 'æ³¨å†ŒæˆåŠŸ',
      data: {
        user: {
          id: newUser.id,
          username: newUser.username,
          email: newUser.email,
          created_at: newUser.created_at
        },
        token: token
      }
    });

  } catch (error) {
    console.error('æ³¨å†Œé”™è¯¯:', error);
    res.status(500).json({
      success: false,
      message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•'
    });
  }
});

// ç”¨æˆ·ç™»å½•
app.post('/api/login', async (req, res) => {
  try {
    const { username, password } = req.body;

    if (!username || !password) {
      return res.status(400).json({
        success: false,
        message: 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç '
      });
    }

    // æŸ¥æ‰¾ç”¨æˆ·
    const user = users.find(u => u.username === username.trim());
    if (!user) {
      return res.status(401).json({
        success: false,
        message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'
      });
    }

    // éªŒè¯å¯†ç 
    const isValid = await bcrypt.compare(password, user.password);
    if (!isValid) {
      return res.status(401).json({
        success: false,
        message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'
      });
    }

    // ç”ŸæˆJWTä»¤ç‰Œ
    const token = jwt.sign(
      {
        id: user.id,
        username: user.username
      },
      JWT_SECRET,
      { expiresIn: '24h' } // ä»¤ç‰Œæœ‰æ•ˆæœŸ24å°æ—¶
    );

    // ç™»å½•æˆåŠŸ
    const { password: _, ...userInfo } = user;

    res.json({
      success: true,
      message: 'ç™»å½•æˆåŠŸ',
      data: {
        user: userInfo,
        token: token
      }
    });

  } catch (error) {
    console.error('ç™»å½•é”™è¯¯:', error);
    res.status(500).json({
      success: false,
      message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•'
    });
  }
});

// è·å–ç”¨æˆ·ä¿¡æ¯
app.get('/api/profile', (req, res) => {
  const userId = parseInt(req.query.userId);

  if (!userId) {
    return res.status(400).json({
      success: false,
      message: 'ç”¨æˆ·IDä¸èƒ½ä¸ºç©º'
    });
  }

  const user = users.find(u => u.id === userId);
  if (!user) {
    return res.status(404).json({
      success: false,
      message: 'ç”¨æˆ·ä¸å­˜åœ¨'
    });
  }

  const { password: _, ...userInfo } = user;

  res.json({
    success: true,
    data: { user: userInfo }
  });
});

// æ›´æ–°ç”¨æˆ·ä¿¡æ¯
app.put('/api/profile', (req, res) => {
  const { userId, updates } = req.body;

  if (!userId) {
    return res.status(400).json({
      success: false,
      message: 'ç”¨æˆ·IDä¸èƒ½ä¸ºç©º'
    });
  }

  const userIndex = users.findIndex(u => u.id === parseInt(userId));
  if (userIndex === -1) {
    return res.status(404).json({
      success: false,
      message: 'ç”¨æˆ·ä¸å­˜åœ¨'
    });
  }

  // æ›´æ–°å…è®¸çš„å­—æ®µ
  if (updates.email !== undefined) {
    users[userIndex].email = updates.email;
  }

  const { password: _, ...userInfo } = users[userIndex];

  res.json({
    success: true,
    message: 'æ›´æ–°æˆåŠŸ',
    data: { user: userInfo }
  });
});

// === å†™ä½œç›¸å…³è·¯ç”± ===

const drafts = [
  {
    id: 1,
    title: 'ç¤ºä¾‹å°è¯´ï¼šå¥‡å¹»ä¹‹æ—…',
    content: 'è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹å°è¯´çš„å†…å®¹ï¼Œè®²è¿°äº†ä¸»äººå…¬åœ¨å¥‡å¹»ä¸–ç•Œä¸­çš„å†’é™©æ•…äº‹...',
    created_at: '2025-10-29T00:00:00Z',
    updated_at: '2025-10-29T00:00:00Z'
  },
  {
    id: 2,
    title: 'ç§‘å¹»æ•…äº‹ï¼šæ˜Ÿé™…è¿œå¾',
    content: 'åœ¨é¥è¿œçš„æœªæ¥ï¼Œäººç±»å·²ç»å¾æœäº†é“¶æ²³ç³»çš„ä¼—å¤šæ˜Ÿçƒ...',
    created_at: '2025-10-28T00:00:00Z',
    updated_at: '2025-10-28T00:00:00Z'
  }
];

// ç« èŠ‚æ•°æ®å­˜å‚¨
let chapterIdCounter = 3;
const chapters = [
  {
    id: 1,
    title: 'ç¬¬ä¸€ç« ï¼šå¼€å§‹',
    content: '<p>è¿™æ˜¯ç¬¬ä¸€ç« çš„å†…å®¹ï¼Œè®²è¿°äº†å†’é™©çš„å¼€å§‹...</p>',
    volumeId: 1,
    bookId: 1,
    order: 1,
    created_at: '2025-10-29T00:00:00Z',
    updated_at: '2025-10-29T00:00:00Z'
  },
  {
    id: 2,
    title: 'ç¬¬äºŒç« ï¼šå†’é™©',
    content: '<p>è¿™æ˜¯ç¬¬äºŒç« çš„å†…å®¹ï¼Œä¸»äººå…¬è¸ä¸Šäº†å†’é™©ä¹‹æ—…...</p>',
    volumeId: 1,
    bookId: 1,
    order: 2,
    created_at: '2025-10-29T00:00:00Z',
    updated_at: '2025-10-29T00:00:00Z'
  }
];

// è·å–æ‰€æœ‰è‰ç¨¿ - éœ€è¦è®¤è¯
app.get('/api/allDraft', authenticateToken, (req, res) => {
  res.json({
    success: true,
    data: drafts
  });
});

// åˆ›å»ºè‰ç¨¿ - éœ€è¦è®¤è¯
app.post('/api/createDraft', authenticateToken, (req, res) => {
  const { title, content } = req.body;

  if (!title) {
    return res.status(400).json({
      success: false,
      message: 'æ ‡é¢˜ä¸èƒ½ä¸ºç©º'
    });
  }

  const newDraft = {
    id: draftIdCounter++,
    title,
    content: content || '',
    user_id: req.user.id, // ä½¿ç”¨è®¤è¯ç”¨æˆ·çš„ID
    created_at: new Date().toISOString(),
    updated_at: new Date().toISOString()
  };

  drafts.push(newDraft);

  res.status(201).json({
    success: true,
    message: 'è‰ç¨¿åˆ›å»ºæˆåŠŸ',
    data: { id: newDraft.id }
  });
});

// è·å–æ ‘å½¢æ•°æ® - éœ€è¦è®¤è¯
app.get('/api/treeData', authenticateToken, (req, res) => {
  const treeData = [
    {
      id: 1,
      title: 'æˆ‘çš„å°è¯´',
      type: 'book',
      children: [
        {
          id: 1,
          title: 'ç¬¬ä¸€å·',
          type: 'volume',
          children: [
            { id: 1, title: 'ç¬¬ä¸€ç« ï¼šå¼€å§‹', type: 'chapter' },
            { id: 2, title: 'ç¬¬äºŒç« ï¼šå†’é™©', type: 'chapter' }
          ]
        }
      ]
    }
  ];

  res.json({
    success: true,
    data: treeData
  });
});

// å…¶ä»–è·¯ç”±çš„ç®€åŒ–ç‰ˆæœ¬
app.post('/api/saveChapter', authenticateToken, (req, res) => {
  const { id, content } = req.body;

  if (!id || content === undefined) {
    return res.status(400).json({
      success: false,
      message: 'ç¼ºå°‘å¿…è¦å‚æ•°'
    });
  }

  // æŸ¥æ‰¾å¹¶æ›´æ–°ç« èŠ‚æ•°æ®
  const chapterIndex = chapters.findIndex(ch => ch.id === parseInt(id));
  if (chapterIndex !== -1) {
    chapters[chapterIndex].content = content;
    chapters[chapterIndex].updated_at = new Date().toISOString();

    console.log(`ç« èŠ‚ ID ${id} å·²æ›´æ–°ï¼Œå†…å®¹é•¿åº¦: ${content.length}`);

    res.json({
      success: true,
      message: 'ç« èŠ‚ä¿å­˜æˆåŠŸ',
      data: chapters[chapterIndex]
    });
  } else {
    res.status(404).json({
      success: false,
      message: 'ç« èŠ‚ä¸å­˜åœ¨'
    });
  }
});

app.get('/api/getChapter/:id', authenticateToken, (req, res) => {
  const chapter = chapters.find(ch => ch.id === parseInt(req.params.id));

  if (!chapter) {
    return res.status(404).json({
      success: false,
      message: 'ç« èŠ‚ä¸å­˜åœ¨'
    });
  }

  res.json({
    success: true,
    data: chapter
  });
});

app.post('/api/saveVolume', authenticateToken, (req, res) => {
  const { title } = req.body;
  const savedVolume = {
    id: Date.now(),
    title,
    order: 1
  };

  res.json({
    success: true,
    message: 'åˆ†å·ä¿å­˜æˆåŠŸ',
    data: savedVolume
  });
});

app.post('/api/createChapter', authenticateToken, (req, res) => {
  const createdChapter = {
    id: Date.now(),
    title: req.body.title || 'æ–°ç« èŠ‚',
    content: req.body.content || ''
  };

  res.json({
    success: true,
    message: 'ç« èŠ‚åˆ›å»ºæˆåŠŸ',
    data: createdChapter
  });
});

// å›¾ç‰‡ä¸Šä¼ æ¥å£ - éœ€è¦è®¤è¯
app.post('/api/upload', authenticateToken, (req, res) => {
  // æ³¨æ„ï¼šè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…é¡¹ç›®ä¸­éœ€è¦ä½¿ç”¨multerç­‰ä¸­é—´ä»¶å¤„ç†æ–‡ä»¶ä¸Šä¼ 
  res.status(501).json({
    success: false,
    message: 'å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½å¾…å®ç°ï¼Œè¯·ä½¿ç”¨æœ¬åœ°å›¾ç‰‡'
  });
});

// æ ¹è·¯ç”±
app.get('/', (req, res) => {
  res.send('kekeYueDu ç®€åŒ–æœåŠ¡å™¨è¿è¡Œä¸­!');
});

// å¯åŠ¨æœåŠ¡å™¨
app.listen(PORT, () => {
  console.log(`ğŸš€ kekeYueDu ç®€åŒ–æœåŠ¡å™¨è¿è¡Œåœ¨ http://localhost:${PORT}`);
  console.log('ğŸ“š æ‰€æœ‰APIç«¯ç‚¹å·²å°±ç»ª');
});

console.log('å¯åŠ¨æµ‹è¯•æœåŠ¡å™¨...');